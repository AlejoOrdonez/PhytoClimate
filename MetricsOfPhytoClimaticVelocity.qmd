---
title: "Velocity metrics"
description: 
  Estimation of climate velocity (magnitude and direction) for the Phytoclimate of multiple growth forms between the Last Glacial maximum (LGM) and contemporary conditions (1950).
author: "Alejandro Ordonez"
date: '`r Sys.Date()`'
bibliography: PhytoClim.bib
format:
  html:
    embed-resources: true
    code-fold: true
editor_options: 
  chunk_output_type: console
project:
  type: website
---

```{r}
#| label: setup
#| include: false
library(terra)
library(maptools)
library(tidyverse)
library(tidyterra)
library(ggnewscale)
## Countries shapefile
data(wrld_simpl)
wrld_simpl <- spTransform(x = wrld_simpl,
                          CRSobj = CRS("+proj=eck4"))
wrld_simpl2 <- vect(wrld_simpl)

## Ice sheets 21ka BP
Ice <- rast("./Data/ice6g_c [PMIP4]/IceCover21kaBP.tif") 

### Matrix of names
NamesDtFrm <- data.frame(Acronym = c("TE", "TDdry", "TDcold", "TN", "ShE", "ShDdry", "ShDcold","H","Geo", "Thero", "GC3", "GC4", "Suc", "Clim"),
                         Acro2 = c("TE", "TD_dry", "TD_cold", "TN", "ShrE", "ShrD_dry", "ShrD_cold", "H","HGeo", "HThero", "G_C3", "G_C4", "Suc", "C"),
                         Name = c("Evergreen trees", "Drought-deciduous trees", "Cold-deciduous trees", "Needleleaf trees", "Evergreen shrubs", "Drought-deciduous shrubs", "Cold-deciduous shrubs","Herbs", "Geophytes", "Therophytes", "C3 grasses", "C4 grasses", "Succulents", "Climbers"))

```

## The setup.

Here, I will be exploring how the velocity based novelty metrics in [@ordonez_mapping_2016] can be used in [@conradi_operational_2020] work on Phyto-climates that builds on his work on operationalizing the definition of the biome for global change research.

The novelty metrics in [@ordonez_mapping_2016] focus on measuring three different mechanisms by which ecological novelty might emerge. These mechanisms are based on the idea that as environmental changes happen the composition of taxa on a site will change change.

**Our goals are:**

-   Developing new metrics of ecosystem change based on velocity *vectors of phytoclimatic* change.

-   Provide a novel and nuanced perspective to identify the ecosystems most at risk from climate change.

## Input information.

Here using will use the maps of growth form (GF) suitability for 14 GFs:

```{r}
#| label: Table
#| echo : FALSE
knitr::kable(NamesDtFrm[,-2])
```

## Data Inputs - Phytoclimates

All analyses use **Phytoclimates** as inputs. These variables can be defined as summaries of the climatic suitability for all plant species with a given growth form (e.g. evergreen tree, grass). Its estimation is based on a physiologically informed suitability model (i.e., an Eco-physiological species distribution Model - *TTR*). The models are based on defining the functional form of physiological constraints to plant growth (as modelled in Dynamic Global Vegetation Models \[DGVMs\]), parameterizing these using occurrence data, and then using the statistical methods of Species Distribution Modelling (SDMs) to define suitability surfaces for each evaluated species..

```{r}
#| label: fig-Maps0kaBP
#| fig-align: center
#| fig-cap: "*Present (1950) suitability per-growth form.*"
#| echo: false

## Load suitability raster for all growth forms for the present time step [1950] - 45th slot in the data list 
Maps0kaBPList <- lapply(dir("./Data/LGM/LatePleistocene/",
                            full.names = T),
                        function(x){rast(x, lyrs= 44)})
# Turn the list into a multi-layer SpatRaster
Maps0kaBP <- do.call("c",Maps0kaBPList)
# Add the GF names to each layer
names(Maps0kaBP) <- sort(NamesDtFrm$Acro2)

# Plot the Suitability Raster
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = Maps0kaBP) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        #labels = seq(0,1,by=0.25), # Legend Labels
                        name = "Suitability", # Legend Title
                        limits=c(0, 1) # Define the limits of the color ramp
                        ) +
  facet_wrap(~lyr) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate Suitability [1950]")
```

The values in the figures above can be defined as the proportion of the species within a growth form for which the environmental conditions at 50x50km a grid-cell are considered suitable at a given period (here 1950; @fig-Maps0kaBP).

## What is the velocity of phytoclimatic change?.

The *Velocity of environmental change idea* is built on the approach developed by [@loarie_velocity_2009], where velocity for an environmental variable (e.g., temperature) is estimated as:

$$V_{l} = \frac{\text{d}c/\text{d}t}{\text{d}c/\text{d}x}$$

Where $\frac{\text{d}c}{\text{d}t}$ is the ratio between the projected change per unit time, and $\frac{\text{d}c}{\text{d}x}$ is the local spatial gradient in the variable of interest.

In this context, velocity vectors for Phytoclimates measure the **rapidity** and **direction** of a change in the suitability of environmental conditions for a growth form. You can think of this as a measurement of how *fast* would the "suitability" surface of a given growth form move in space (like in [@serra-diaz_bioclimatic_2014]).

This metric answer the question, *"How fast to move to keep the same 'suitability'"*, assuming that the movement is from an area of low to a place of higher suitability between two times points. A 10km/year value means that to compensate for the change in 1yr, you would need to move to a location 10km away. Here, I apply this approach to each growth form suitability map rather than a single climate variable.

The approach used to estimate the velocity of phytoclimatic change (that is, the magnitude and direction of the change vector) flowing the implementation in [@ordonez_combined_2014] and [@ordonez_mapping_2016].

## Maping the velocity of phytoclimatic change.

The magnitude of Phytoclimate velocity vectors (i.e., speed; @fig-VelocitySummary) was the fastest in most of the northern hemisphere, particularly those areas covered by ice sheets during the LGM ([the Cordillera, Laurentide, Innuitian, Greenland, Barents-Kara, Fennoscandia and British-Irish Ice Sheets](https://en.wikipedia.org/wiki/Last_Glacial_Maximum); see [@ehlers_quaternary_2011]). *most likely due to Large temporal changes in suitability*.

The Sahara and central and western Australia regions also show large velocities for all GF (@fig-VelocitySummary), particularly drought-deciduous shrubs(ShDdry), drought-deciduous trees (TDdry), Therophytes (Thero), and needle leaf trees (TN)). Such fast speeds are likely due to low suitability for these GF and due to homogeneous spatial patterns.

```{r}
#| label: fig-VelocitySummary
#| fig-align: center
#| fig-cap: Rate at which each phytoclimates would have moved between the LGM to the Present day [Speed km/100yrs].
#| echo: false

# Load the Velocity Rasters
VelocityRast <- do.call("c",
                        lapply(dir("./Data/LGM/Velocity/Velocity_Anomaly2",
                                   pattern ="All_",
                                   full.names = TRUE),
                               function(x){rast(x)}))
names(VelocityRast) <- sort(NamesDtFrm$Acronym)

# Plot the Velocities 
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = log10(VelocityRast)) + # Map the Displacement
# Setup. plot of a continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        breaks = -3:3, # Legend breaks
                        labels = c(">1000","100","10","1","0.1","0.01","<0.001"), # Legend Labels
                        name = "Speed\n[km*100yrs]" # Legend Title
                        ) +
  facet_wrap(~lyr) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate Velocities") # Fig title
  
```

When comparing the velocity between growth forms in each cell, Climbers (Clim) were the group that showed, in most cases, the fastest speeds for a grid (@fig-FastestGF1). If Climbers are removed from the analysis, C3 and C4 grasses become the growth forms with the fastest velocities (@fig-FastestGF2).


```{r}
#| label: fig-FastestGF1
#| fig-align: center
#| fig-cap: Phytoclimate that has the fastest velocity vector for a given cell. Velocity vectors determine the movement of the suitability isocline between LGM to the Present day.
#| echo: false

# Define the Fastest GF per cell (All GF)
FastGF <- app(VelocityRast,function(x){ifelse(is.na(x[1]),NA,order(x, decreasing = T)[1])})
# Make the raster a factor
FastGF <- as.factor(FastGF)
levels(FastGF)[[1]]$label <- names(VelocityRast)
# plot the raster raster

ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = FastGF) + # Map the Displacement
# Setup. plot for continuous raster
  scale_fill_whitebox_d(palette = "muted",
                        na.value = NA,
                        name = "Growth Form") +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "GF with the fastest Velocity") # Fig title

```

```{r}
#| label: fig-FastestGF2
#| fig-align: center
#| fig-cap: Phytoclimate that has the fastest velocity vector for a given cell. Estimates exclude climbers. Velocity vectors determine the movement of the suitability isocline between LGM to the Present day.
#| echo: false

# Define the Fastest GF per cell (No Climbers)
FastGF <- app(VelocityRast,function(x){ifelse(is.na(x[1]),NA,order(x[-1], decreasing = T)[1])})
# Make the raster a factor
FastGF <- as.factor(FastGF)
levels(FastGF)[[1]]$label <- names(VelocityRast)[-1]
# plot the raster raster

ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = FastGF) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_whitebox_d(palette = "muted",
                        na.value = NA,
                        name = "Growth Form") +
    new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "GF with the fastest Velocity\nExcluding Climbers") # Fig title
```

## Maping the displacement of phytoclimate velocity vectors. 

A compound metric of change, that shows the **average rapidity** in the response across multiple variables is the **displacement** of velocity vectors (cf. [@ordonez_mapping_2016]). You can think of it as a metric of how fast would you need to move the keep the same environmental setup.

**NOTE:** *Could this be considered how fast would a given GF assemblage (defined by their suitability) need to move to in response to environmental changes?*

Using the phytoclimate velocity vectors, the displacement of these is estimated (@fig-MapDisplacement) using the suitability composition for all GF in a location.

```{r}
#| label: fig-MapDisplacement
#| fig-align: center
#| fig-cap: Rate at which phytoclimates would have moved between the LGM to the Present day (Displacement km/100yrs).
#| echo: false

#Load the Displacement values
Displacement <- rast("./Data/LGM/Displacement/Displacement_Anomaly2/All_Displacement.tif")

## ggplot
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = log10(Displacement)) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
breaks = -3:3, # Legend breaks
                        labels = c(">1000","100","10","1","0.1","0.01","<0.001"), # Legend Labels
                         name = "Displacement\n[km*100yrs]" # Legend Title
                        ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement.")
```

This map shows again that the displacement of Phytoclimate velocity vectors (@fig-MapDisplacement) was the fastest in most of the northern hemisphere, particularly those areas covered by ice sheets during the LGM ([the Cordillera, Laurentide, Innuitian, Greenland, Barents-Kara, Fennoscandia and British-Irish Ice Sheets](https://en.wikipedia.org/wiki/Last_Glacial_Maximum); see [@ehlers_quaternary_2011]).

Is also relevant to consider the balance between the **average** and **variability** in the rapidity of velocity vectors (@fig-DivAvgVsSD).

```{r}
#| label: fig-DivAvgVsSD
#| fig-cap: Match between displacement Avg and displacement variability.
#| fig-align: center
#| echo: false

# Functions for 2D colors
colors=c("orange","blue","yellow", "red")
colors <- col2rgb(colors)/255
interpolate <- function(i){
  if(!is.na(i[1])){
    x <- i[1]
    y <- i[2]
    x1 <- colors[,2] * x + colors[,3] * (1-x)
    x2 <- colors[,1] * x + colors[,4] * (1-x)
    x2 * y + x1 * (1-y)
  } else{
    c(NA,NA,NA)
  }
}

# Scale Displacement - Avg
DisplaceAvg <- app(log10(Displacement),function(x){scales::rescale(x,from = as.numeric(minmax(log10(Displacement))))})
# Scale Displacement - sd
DisplaceSD <- app(VelocityRast,sd,na.rm=T)+1
DisplaceSD <- app(log10(DisplaceSD),function(x){scales::rescale(x,from = c(0,as.numeric(minmax(log10(DisplaceSD)))[2]))})

# Merge into a single SpatRaster
Displace2D <- c(DisplaceAvg,
                DisplaceSD)
# Turn values into RGB 
Displace2DRGB <- app(Displace2D,
                     interpolate)

# Plot the RGB
RGBPlot <- ggplot(wrld_simpl2) +
  geom_spatraster_rgb(data = Displace2DRGB,
                      max_col_value =1,
                      ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement Avg Vs displacement SD") # Fig title

# Legend
X <- rast(matrix(rep(seq(0,1,length.out=10),
                     each=10),
                 ncol=10))
Y <- rast(matrix(rep(seq(0,1,length.out=10),
                     each=10),
                 ncol=10,
                 byrow=T))
XY <- c(X,Y)
XY <- app(XY,interpolate)
leg2d <- ggplot() +
  geom_spatraster_rgb(data = XY,
                      max_col_value =1
                      ) +
  scale_x_continuous(name = "Displacement - Avg",
                     breaks = seq(0,10,length.out=7),
                     labels = 10^(-3:3),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Displacement - SD",
                     breaks = seq(0,10,length.out=4),
                     labels = 10^(0:3)) +
  theme(axis.text = element_text(size=6),
        axis.title = element_text(size=6,face="bold"),
        panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent'))
# Turn the Legend into a Grob
g <- ggplotGrob(leg2d)


# Add the legend as a insert to the RGB plot
RGBPlot +
  annotation_custom(
    grob = g,
    xmin = -16800000,
    xmax = -8253891,
    ymin = -8815273,
    ymax = -50573
  )

```



