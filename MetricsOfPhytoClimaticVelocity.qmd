---
title: "Velocity metrics"
description: 
  Estimation of climate velocity (magnitude and direction) for the Phytoclimate of multiple growth forms between the Last Glacial maximum (LGM) and contemporary conditions (1950).
author: "Alejandro Ordonez"
date: '`r Sys.Date()`'
bibliography: PhytoClim.bib
format:
  html:
    embed-resources: true
    code-fold: true
editor_options: 
  chunk_output_type: console
project:
  type: website
---

```{r}
#| label: setup
#| include: false
library(terra)
library(maptools)
library(tidyverse)
library(tidyterra)
library(ggnewscale)
## Countries shapefile
data(wrld_simpl)
wrld_simpl <- spTransform(x = wrld_simpl,
                          CRSobj = CRS("+proj=eck4"))
wrld_simpl2 <- vect(wrld_simpl)

## Ice sheets 21ka BP
Ice <- rast("./Data/ice6g_c [PMIP4]/IceCover21kaBP.tif") 

### Matrix of names
NamesDtFrm <- data.frame(Acronym = c("TE", "TDdry", "TDcold", "TN", "ShE", "ShDdry", "ShDcold","H","Geo", "Thero", "GC3", "GC4", "Suc", "Clim"),
                         Acro2 = c("TE", "TD_dry", "TD_cold", "TN", "ShrE", "ShrD_dry", "ShrD_cold", "H","HGeo", "HThero", "G_C3", "G_C4", "Suc", "C"),
                         Name = c("Evergreen trees", "Drought-deciduous trees", "Cold-deciduous trees", "Needleleaf trees", "Evergreen shrubs", "Drought-deciduous shrubs", "Cold-deciduous shrubs","Herbs", "Geophytes", "Therophytes", "C3 grasses", "C4 grasses", "Succulents", "Climbers"))

```

## The setup.

Here, I will be exploring how the velocity based novelty metrics in [@ordonez_mapping_2016] can be used in [@conradi_operational_2020] work on Phyto-climates that builds on his work on operationalizing the definition of the biome for global change research.

The novelty metrics in [@ordonez_mapping_2016] focus on measuring three different mechanisms by which ecological novelty might emerge. These mechanisms are based on the idea that as environmental changes happen the composition of taxa on a site will change change.

**Our goals are:**

-   Developing new metrics of ecosystem change based on velocity *vectors of phytoclimatic* change.

-   Provide a novel and nuanced perspective to identify the ecosystems most at risk from climate change.

## Input information.

Here using will use the phytoclimates maps of 14 growth form (GF):

```{r}
#| label: Table
#| echo : FALSE
knitr::kable(NamesDtFrm[,-2])
```

## Data Inputs - Phytoclimates.

All analyses use **Phytoclimates** as inputs. These variables can be defined as summaries of the climatic suitability for all plant species with a given growth form (e.g. evergreen tree, grass). Its estimation is based on a physiologically informed suitability model (i.e., an Eco-physiological species distribution Model - *TTR*). The models are based on defining the functional form of physiological constraints to plant growth (as modelled in Dynamic Global Vegetation Models \[DGVMs\]), parameterizing these using occurrence data, and then using the statistical methods of Species Distribution Modelling (SDMs) to define suitability surfaces for each evaluated species..

```{r}
#| label: fig-Maps0kaBP
#| fig-align: center
#| fig-cap: "*Present (1950) suitability per-growth form.*"
#| echo: false

## Load suitability raster for all growth forms for the present time step [1950] - 45th slot in the data list 
Maps0kaBPList <- lapply(dir("./Data/LGM/LatePleistocene/",
                            full.names = T),
                        function(x){rast(x, lyrs= 44)})
# Turn the list into a multi-layer SpatRaster
Maps0kaBP <- do.call("c",Maps0kaBPList)
# Add the GF names to each layer
names(Maps0kaBP) <- sort(NamesDtFrm$Acro2)

# Plot the Suitability Raster
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = Maps0kaBP) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        #labels = seq(0,1,by=0.25), # Legend Labels
                        name = "Suitability", # Legend Title
                        limits=c(0, 1) # Define the limits of the color ramp
                        ) +
  facet_wrap(~lyr) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate Suitability [1950]")
```

The values in the figures above (i.e., phytoclimate suitability) can be defined as the proportion of the species within a growth form for which the environmental conditions at 50x50km a grid-cell are considered suitable at a given period (here 1950; @fig-Maps0kaBP).

## What is the velocity of phytoclimatic change?

The *Velocity of environmental change idea* is built on the approach developed by [@loarie_velocity_2009], where velocity for an environmental variable (e.g., temperature) is estimated as:

$$V_{l} = \frac{\text{d}c/\text{d}t}{\text{d}c/\text{d}x}$$

Where $\frac{\text{d}c}{\text{d}t}$ is the ratio between the projected change per unit time, and $\frac{\text{d}c}{\text{d}x}$ is the local spatial gradient in the variable of interest.

In this context, velocity vectors for phytoclimates measure the rapidity (**speed**) and direction (**bearing**) of a change in the suitability of environmental conditions for the species in a given growth form. You can think of this as a measurement of how *fast* , and in which *direction* would the "suitability" surface of an average species in a given growth form has/will move in space (like in [@serra-diaz_bioclimatic_2014]).

This metric answer the question, *"How fast to move to keep the same 'suitability'"*, assuming that the movement is from an area of low to a place of higher suitability between two times points. A 10km/year value means that to compensate for the change in 1yr, you would need to move to a location 10km away. I apply this approach to each phytoclimates suitability map rather than a single climate variable.

The approach used to estimate the velocity of phytoclimatic change (that is, the magnitude and direction of the change vector) flows the implementation in [@ordonez_combined_2014] and [@ordonez_mapping_2016].

## Maping the speed of phytoclimatic change.

The magnitude of Phytoclimate velocity vectors (i.e., speed; @fig-VelocitySummary) was the fastest in most of the northern hemisphere, particularly those areas covered by ice sheets during the LGM ([the Cordillera, Laurentide, Innuitian, Greenland, Barents-Kara, Fennoscandia and British-Irish Ice Sheets](https://en.wikipedia.org/wiki/Last_Glacial_Maximum); see [@ehlers_quaternary_2011]). *most likely due to Large temporal changes in suitability*.

The Sahara and central and western Australia regions also show large velocities for all phytoclimates (@fig-VelocitySummary), particularly those from drought-deciduous shrubs(ShDdry), drought-deciduous trees (TDdry), Therophytes (Thero), and needle leaf trees (TN) growth forms. Such fast speeds are likely due to low suitability for these phytoclimates and due to homogeneous spatial patterns.

```{r}
#| label: fig-VelocitySummary
#| fig-align: center
#| fig-cap: Rate at which each phytoclimates would have moved between the LGM to the Present day [Speed km/100yrs].
#| echo: false

# Load the Velocity Rasters
VelocityRast <- do.call("c",
                        lapply(dir("./Data/LGM/Velocity/Velocity_Anomaly2",
                                   pattern ="All_",
                                   full.names = TRUE),
                               function(x){rast(x)}))
names(VelocityRast) <- sort(NamesDtFrm$Acronym)

# Plot the Velocities 
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = log10(VelocityRast)) + # Map the Displacement
# Setup. plot of a continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        breaks = -3:3, # Legend breaks
                        labels = c(">1000","100","10","1","0.1","0.01","<0.001"), # Legend Labels
                        name = "Speed\n[km*100yrs]" # Legend Title
                        ) +
  facet_wrap(~lyr) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate Velocities") # Fig title
  
```

### Fastest changing phytoclimate.

When comparing the velocity between phytoclimates in each cell (i.e., suitability for the avg species in growth forms), Climbers (Clim) were the group that showed, in most cases, the fastest speeds for a grid (@fig-FastestGF1). If Climbers are removed from the analysis, C3 and C4 grasses become the growth forms with the fastest velocities (@fig-FastestGF2).


```{r}
#| label: fig-FastestGF1
#| fig-align: center
#| fig-cap: Phytoclimate that has the fastest velocity vector for a given cell. Velocity vectors determine the movement of the suitability isocline between LGM to the Present day.
#| echo: false

# Define the Fastest GF per cell (All GF)
FastGF <- app(VelocityRast,function(x){ifelse(is.na(x[1]),NA,order(x, decreasing = T)[1])})
# Make the raster a factor
FastGF <- as.factor(FastGF)
levels(FastGF)[[1]]$label <- names(VelocityRast)
# plot the raster raster

ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = FastGF) + # Map the Displacement
# Setup. plot for continuous raster
  scale_fill_manual(values = rev(hcl.colors(14, palette = "RdYlBu", alpha = 0.7)),
                    na.value = NA,
                    name = "Growth Form") +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "GF with the fastest Velocity") # Fig title

```

```{r}
#| label: fig-FastestGF2
#| fig-align: center
#| fig-cap: Phytoclimate that has the fastest velocity vector for a given cell. Estimates exclude climbers. Velocity vectors determine the movement of the suitability isocline between LGM to the Present day.
#| echo: false

# Define the Fastest GF per cell (No Climbers)
FastGF <- app(VelocityRast,function(x){ifelse(is.na(x[1]),NA,order(x[-1], decreasing = T)[1])})
# Make the raster a factor
FastGF <- as.factor(FastGF)
levels(FastGF)[[1]]$label <- names(VelocityRast)[-1]
# plot the raster raster

ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = FastGF) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_manual(values = rev(hcl.colors(14, palette = "RdYlBu", alpha = 0.7))[-1],
                    na.value = NA,
                    name = "Growth Form") +
    new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "GF with the fastest Velocity\nExcluding Climbers") # Fig title
```

## Maping the displacement of phytoclimate velocity vectors. 

A compound metric of change that shows the **average rapidity** in the response across multiple variables is the **displacement** of velocity vectors (cf. [@ordonez_mapping_2016]). It is a metric of how fast you would need to move the keep the same environmental setup.

**NOTE:** *Could this be considered as to how fast a given phytoclimate assemblage (defined by its suitability) must move in response to environmental changes?*

Using the phytoclimate velocity vectors, these displacement is estimated (@fig-MapDisplacement) using the suitability composition for all phytoclimates in a location.

```{r}
#| label: fig-MapDisplacement
#| fig-align: center
#| fig-cap: Rate at which phytoclimates would have moved between the LGM to the Present day. Displacement is measured as the mean speed of phytoclimate velocity vectors.
#| echo: false

#Load the Displacement values
Displacement <- rast("./Data/LGM/Displacement/Displacement_Anomaly2/All_Displacement.tif")

## ggplot
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = log10(Displacement)) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
breaks = -3:3, # Legend breaks
                        labels = c(">1000","100","10","1","0.1","0.01","<0.001"), # Legend Labels
                         name = "Displacement\n[km*100yrs]" # Legend Title
                        ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement.")
```

This map shows again that the displacement of phytoclimate velocity vectors (@fig-MapDisplacement) was the fastest in most of the northern hemisphere, particularly those areas covered by ice sheets during the LGM ([the Cordillera, Laurentide, Innuitian, Greenland, Barents-Kara, Fennoscandia and British-Irish Ice Sheets](https://en.wikipedia.org/wiki/Last_Glacial_Maximum); see [@ehlers_quaternary_2011]).

### Sensitivity of displacement estimates.

The displacement of phytoclimates showed the highest sensitivity in most evaluated cells to the speed of drought-deciduous shrubs (ShDdry)  (@fig-Sensitivity). This sensitivity was estimated as the absolute difference between displacement estimate with all phytoclimates and the estimation after removing a given phytoclimate. 

A second group of phytoclimates with a strong influence on displacement estimates (@fig-Sensitivity) were Cold-deciduous trees (TDcold), Needle-leaf trees (TN), Evergreen trees (TE), and Drought-deciduous trees (TDdry). These were the most influential phytoclimates in a similar number of cells.

```{r}
#| label: fig-Sensitivity
#| fig-align: center
#| fig-height: 10
#| fig-cap: Phytoclimate that has the most considerable influence of the displacement estimate for a given cell (A) and the number of cells for which a given phytoclimate has the largest influence (B). Effect estimated as the absolute deviation between displacement estimate with all phytoclimates and the estimation after removing a given phytoclimate (i.e., GF). 
#| echo: FALSE

# Estimate the Difference between the displacement estimate using all GF and removing one GF at a time
SensitivityRastList <- lapply(1:dim(VelocityRast)[3],
                          function(i){
                            log10(abs(10^mean(log10(VelocityRast[[-i]])) - Displacement))
                            })
SensitivityRast <- do.call("c",SensitivityRastList)
names(SensitivityRast) <- names(VelocityRast)

# Define the GF with the largest influence
GFInflu <- app(SensitivityRast,
               function(x){
                 ifelse(is.na(x[1]),NA,
                        ifelse(length(unique(x))==1, 0,
                               order(x,decreasing = T)[1]))
               })
GFInflu <- as.factor(GFInflu)
levels(GFInflu)[[1]]$label <- c("All equal",names(VelocityRast))

# Plot the Raster
RAst <- ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = GFInflu) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_manual(values = c("darkgrey",rev(hcl.colors(14, palette = "RdYlBu", alpha = 0.7))),
                    na.value = NA,
                    name = "Growth Form") +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
  geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate with the largest influence on the displacement estimate") # Fig title

# Make a frequency bar plot
a <- table(values(GFInflu))
a <- data.frame(GF = levels(GFInflu)[[1]][,2],
                Freq = as.numeric(a))
BarplotPlt <- ggplot(a,   aes(x=GF,
                y=Freq,fill=GF)) +
  geom_bar(stat="identity") +
  scale_fill_manual(values =  c("darkgrey",rev(hcl.colors(14, palette = "RdYlBu", alpha = 0.7))))
  
# Plot both the map and 
ggpubr::ggarrange(RAst, BarplotPlt,
             nrow = 2,
             labels = c("A", "B"))  
```

### Displacement: Mean vs Variability.

It is also relevant to consider the balance between the **average** and **variability** in the rapidity of velocity vectors (@fig-DivAvgVsSD). These show that for most areas, there is an overall consistency in the velocity of phytoclimates (for most cells, the variability is low (median variability ~```r round(median(app(VelocityRast,sd,na.rm=T)[],na.rm=T),2)```km/100yrs), a value that is comparable to the median velocity of phytoclimates (~```r round(median(Displacement[],na.rm=T),2)```km/100yrs).

```{r}
#| label: fig-DivAvgVsSD
#| fig-cap: Match between displacement Avg and displacement variability in space (A) and in a 2D-histogram (B). 
#| fig-align: center
#| fig-height: 10
#| echo: false

# Functions for 2D colors
colors=c("orange","blue","yellow", "red")
colors <- col2rgb(colors)/255
interpolate <- function(i){
  if(!is.na(i[1])){
    x <- i[1]
    y <- i[2]
    x1 <- colors[,2] * x + colors[,3] * (1-x)
    x2 <- colors[,1] * x + colors[,4] * (1-x)
    x2 * y + x1 * (1-y)
  } else{
    c(NA,NA,NA)
  }
}

# Define the color space -legend
brakes <- 10
X <- rast(matrix(rep(seq(0,1,length.out=brakes),
                     each=brakes),
                 ncol=brakes))

Y <- rast(matrix(rep(seq(0,1,length.out=brakes),
                     each=brakes),
                 ncol=brakes,
                 byrow=T))
# Merge into a single SpatRaster
XY <- c(X,Y)
# Turn into an RGB
XY <- app(XY,interpolate)

# Match the values to the color space 

# Scale Displacement - Avg
LogDisp <- app(log10(VelocityRast),mean,na.rm=T)
DisplaceAvg <- app(LogDisp,
                   function(x){
                     scales::rescale(x,
                                     from = as.numeric(minmax(LogDisp)),
                                     to = c(0,brakes))})
# Scale Displacement - sd
LogDispSD <- log10(app(VelocityRast,sd,na.rm=T)+1)
DisplaceSD <- app(LogDispSD,
                  function(x){
                    scales::rescale(x,
                                    from = as.numeric(minmax(LogDispSD)),
                                    to = c(0,brakes))})
# Merge into a single SpatRaster
Disp.Av.SD <- c(DisplaceAvg,DisplaceSD)
names(Disp.Av.SD) <- c("x", "y")

# Get RGB colors for the average vs SD combination
XY2 <- terra::extract(XY,
                      values(Disp.Av.SD))

# Make the RGB map
Displace2DRGB <- rast(nrows=dim(DisplaceAvg)[1],
                      ncols=dim(DisplaceAvg)[2],
                      nlyrs=3,
                      crs = crs(DisplaceAvg),
                      extent = ext(DisplaceAvg))
Displace2DRGB <- setValues(Displace2DRGB, XY2)


# Plot the RGB
RGBPlot <- ggplot(wrld_simpl2) +
  geom_spatraster_rgb(data = Displace2DRGB,
                      max_col_value =1
                      ) +
  new_scale_fill() + # clear fill set-up 
  # Plot the Ice extend
  geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
  ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement Avg Vs displacement SD") # Fig title

# Plot Legend 
leg2d <- ggplot() +
  geom_spatraster_rgb(data = XY,
                      max_col_value =1) +
  scale_x_continuous(name = "Displacement - Avg",
                     breaks = seq(0,10,length.out=7),
                     labels = 10^(-3:3),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Displacement - SD",
                     breaks = seq(0,10,length.out=4),
                     labels = 10^(0:3)) +
  theme(axis.text = element_text(size=6),
        axis.title = element_text(size=6,face="bold"),
        panel.background = element_rect(fill='transparent'),
        panel.border = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent'))

# Turn the Legend into a Grob [grid graphical object] to be inserted in a ggplot
g <- ggplotGrob(leg2d)


# Add the legend as a insert to the RGB plot
Map2D <- RGBPlot +
  annotation_custom(
    grob = g,
    xmin = -16800000,
    xmax = -8253891,
    ymin = -8815273,
    ymax = -50573
  )


# Bin size control + color palette
a<- values(Disp.Av.SD,
              na.rm=T,
              dataframe=T)
a <- a[a[,2]!=0,]
hist2D <- ggplot(round(a,1)) +
  aes(x=x, y=y) +
  geom_hex(bins = 50) +
  scale_fill_continuous(type = "viridis",
                        trans = "log10",
                        na.value = NA,#Do not map NA
                        name = expression(atop('Frequency',
                                          'log'[10]*"(count)")
                          )) +
  scale_x_continuous(name = "Displacement - Avg",
                     breaks = seq(0,brakes,length.out=7),
                     labels = 10^(-3:3),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Displacement - SD",
                     breaks = seq(0,brakes,length.out=4),
                     labels = 10^(0:3))
# plot the 2D-map and 2d-Histogram 
ggpubr::ggarrange(Map2D, hist2D,
             nrow = 2,
             labels = c("A", "B"))  

```

## Maping the bearing of phytoclimatic vectors.

A second dimension of velocity vectors is their direction, which is *the angle measured counter-clockwise from north*. Here I adjusted these so they represent poleward/equatorward directions (0-degrees is pole ward, 180 degree is equatorward). in this way, bearing measurement show show the movement from the tropics to temperate to polar areas. 

For most phytoclimates, vectors show a *Poleward* direction (@fig-Bearing), aligned with the idea of a colonization of post-glaciated areas. However, for the large areas covered by the [the Cordillera, Laurentide, Innuitian, Greenland, Barents-Kara, Fennoscandia and British-Irish Ice Sheets](https://en.wikipedia.org/wiki/Last_Glacial_Maximum); see [@ehlers_quaternary_2011]) is not possible to estimate the bearing due to homogeneous/flat spatial gradients.


```{r}
#| label: fig-Bearing
#| fig-align: center
#| fig-cap: Overall bearing of phytoclimate vectors between the LGM to the Present day.
#| echo: false

#Load the bearings
BearingRast <- do.call("c",
                        lapply(dir("./Data/LGM/Velocity/Bearing",
                                   pattern ="All_",
                                   full.names = TRUE),
                               function(x){y <- app(rast(x),
                                                    function(x){ifelse(is.na(x),NA,
                                                    findInterval(x,c(0,seq(22.5,337.5,45),360,361)))})
                                           y <- app(y,function(x){ifelse(is.na(x),NA,
                                                                    ifelse(x%in%c(9,10),1,x))})
                                           y <- as.factor(y)
                                           levels(y)[[1]][,2] <- c("Pol","Pole-West",
                                                                   "West","Equ-West",
                                                                   "Equ","Equ-East",
                                                                   "East","Pole-East",
                                                                   "NoChng")
                                           return(y)}))

names(BearingRast) <- names(VelocityRast)
# Plot the the Bearing of Velocities 
ggplot() + # add the vector of the world
  geom_spatraster(data = BearingRast) + # Map the Displacement
# Setup. plot of a continuous raster
  scale_fill_manual(values = c(rev(hcl.colors(8, palette = "RdYlBu", alpha = 0.7)),"darkgrey"), #colour scheme 
                    na.value = NA, #Do not map NA
                        name = "Bearing" # Legend Title
                        ) +
  facet_wrap(~lyr) +
  labs(title = "Bearing Phytoclimate Velocities") # Fig title

# Sort the directions by number of cells with a given bearing
#lapply(1:14,
#       function(x){
#         levels(BearingRast)[[x]][,2][order(table(values(BearingRast[[x]],na.rm=T)))]
#       })
```

## Maping the divergence of phytoclimate velocity vectors.

Differences in the bearing of phytoclimate velocity vectors were small overall as shown by the overall low median angle between phytoclimate velocity vectors (i.e., divergence; (@fig-Divergence)). In those areas where bearings did nit converge, there is a general trend towards orthogonal bearings (e.g., Cerrado region, Northern and central Africa, Borneo, Eastern Australia; see (@fig-Divergence)), indicating a possible dissociation in the suitability fo different phytoclimates.


```{r}
#| label: fig-Divergence
#| fig-align: center
#| fig-cap: Concordance in the bearing angle of phytoclimate velocity vectors (divergence) between the LGM to the Present day. Divergence is measured as the median angle between phytoclimate velocity vectors.
#| echo: false

# Load the bearings
BearingRast <- do.call("c",
                        lapply(dir("./Data/LGM/Velocity/Bearing",
                                   pattern ="All_",
                                   full.names = TRUE),
                               function(x){rast(x)}))
# Estimate the Divergence as the median difference between bearings
Divergence <- app(BearingRast,
                  function(x){
                    if(is.na(x[1])){out<-NA
                    } else{x <- x[x!=361]
                           #x <- round(x,1) 
                           y <- dist(na.omit(x))
                           y[y>180] <- 360 - y[y>180]
                           out <- median(y) }
                    return((out))
                    })

# Plot the displacement
## ggplot
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = Divergence) + # Map the Displacement
# Setup. plot of continuous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        name = "Divergence\n[Degrees]", # Legend Title
                        limits = c(0,180),
                        breaks = seq(0,180,60)
                        ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate divergence.")
```

### Bearing Mean vs variability

To further test the idea that bearings of phytoclimates show similar directions, I plot the mean vs the variability in the angles between pairwise phytoclimatic velocity vectors. These show that for some cells there is a large variability in the match in directions between vectors (@fig-DiverAvgVSVar A), for the vast majority of locations divergence is low (>60 degrees), and with a low variability (>225. degrees) (@fig-DiverAvgVSVar B).

```{r}
#| label: fig-DiverAvgVSVar
#| fig-cap: Match between the Divergecne Avg and displacement variability in space (A) and in a 2D-histogram (B). 
#| fig-align: center
#| fig-height: 10
#| echo: false

# Scale Displacement - Avg
DivergenceAvg <- app(Divergence,
                   function(x){
                     scales::rescale(x,
                                     from = as.numeric(minmax(Divergence)),
                                     to = c(0,brakes))})
# Estimate Divergence Sd
DivergenceSD <- app(BearingRast,
                  function(x){
                    if(is.na(x[1])){out<-NA
                    } else{x <- x[x!=361]
                           #x <- round(x,1) 
                           y <- dist(na.omit(x))
                           y[y>180] <- 360 - y[y>180]
                           out <- sd(y) }
                    return((out))
                    })
# Scale Displacement - sd
DivergenceSD <- app(DivergenceSD,
                  function(x){
                    scales::rescale(x,
                                    from = as.numeric(minmax(DivergenceSD)),
                                    to = c(0,brakes))})
# Merge into a single SpatRaster
Div.Av.SD <- c(DivergenceAvg,DivergenceSD)
names(Div.Av.SD) <- c("x", "y")

# Get RGB colors for the average vs SD combination
XY2 <- terra::extract(XY,
                      values(Div.Av.SD))

# Make the RGB map
Divergence2DRGB <- rast(nrows=dim(Div.Av.SD)[1],
                      ncols=dim(Div.Av.SD)[2],
                      nlyrs=3,
                      crs = crs(Div.Av.SD),
                      extent = ext(Div.Av.SD))
Divergence2DRGB <- setValues(Divergence2DRGB, XY2)

# Plot the RGB
RGBPlot <- ggplot(wrld_simpl2) +
  geom_spatraster_rgb(data = Divergence2DRGB,
                      max_col_value =1
                      ) +
  new_scale_fill() + # clear fill set-up 
  # Plot the Ice extend
  geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
  ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate divergence Avg Vs divergence SD") # Fig title

# Plot Legend 
leg2d <- ggplot() +
  geom_spatraster_rgb(data = XY,
                      max_col_value =1) +
  scale_x_continuous(name = "Divergence - Avg",
                     breaks = seq(0,10,length.out=4),
                     labels = seq(0,180,60),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Divergence - SD",
                     breaks = seq(0,10,length.out=5),
                     labels = seq(0,90,by=22.5)) +
  theme(axis.text = element_text(size=6),
        axis.title = element_text(size=6,face="bold"),
        panel.background = element_rect(fill='transparent'),
        panel.border = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent'))

# Turn the Legend into a Grob [grid graphical object] to be inserted in a ggplot
g <- ggplotGrob(leg2d)

# Add the legend as a insert to the RGB plot
Map2D <- RGBPlot +
  annotation_custom(
    grob = g,
    xmin = -16800000,
    xmax = -8253891,
    ymin = -8815273,
    ymax = -50573
  )


# Bin size control + color palette
a<- values(Div.Av.SD,
              na.rm=T,
              dataframe=T)
a <- a[a[,2]!=0,]
hist2D <- ggplot(round(a,1)) +
  aes(x=x, y=y) +
  geom_hex(bins = 50) +
  scale_fill_continuous(type = "viridis",
                        trans = "log10",
                        na.value = NA,#Do not map NA
                        name = expression(atop('Frequency',
                                          'log'[10]*"(count)")
                          )) +
  scale_x_continuous(name = "Divergence - Avg",
                     breaks = seq(0,10,length.out=4),
                     labels = seq(0,180,60),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Divergence - SD",
                     breaks = seq(0,10,length.out=5),
                     labels = seq(0,90,by=22.5))
# plot the 2D-map and 2d-Histogram 
ggpubr::ggarrange(Map2D, hist2D,
             nrow = 2,
             labels = c("A", "B"))  



```

## Displacement vs Divergence

When merging the displacement and divergence metrics into a single visualization (@fig-DisVSDiv), Most cells have divergences of ~1km/100yrs and low overall divergence (<60 degrees difference between vector bearings).

However, we can distinguish areas where the rate and directional of movement of acclimate velocity vectors is on the top end with speeds ~1000km/100yrs and most vectors going in opposite directions (180degree of divergence) (blue colours in (@fig-DisVSDiv)). These areas correspond to Boreal areas, North American Central plains, the Saharan region, the Arabian peninsula, and northwestern India. 

```{r}
#| label: fig-DisVSDiv
#| fig-cap: DIvergecne Vs Displacement
#| fig-align: center
#| fig-height: 10
#| echo: false

# Scale Displacement - Avg
DisplaceAvg <- app(log10(Displacement),
                   function(x){
                     scales::rescale(x,
                                     from = as.numeric(minmax(log10(Displacement))),
                                     to = c(0,brakes))})
# Scale divergence - sd
DivergenceMed <- app(Divergence,
                  function(x){
                    scales::rescale(x,
                                    from = as.numeric(minmax(Divergence)),
                                    to = c(0,brakes))})
# Merge into a single SpatRaster
Disp.Dive <- c(DisplaceAvg,DivergenceMed)
names(Disp.Dive) <- c("x", "y")

# Get RGB colors for the average vs SD combination
XY2 <- terra::extract(XY,
                      values(Disp.Dive))

# Make the RGB map
DisDiv2DRGB <- rast(nrows=dim(DisplaceAvg)[1],
                      ncols=dim(DisplaceAvg)[2],
                      nlyrs=3,
                      crs = crs(DisplaceAvg),
                      extent = ext(DisplaceAvg))
DisDiv2DRGB <- setValues(DisDiv2DRGB, XY2)
# Plot the RGB
RGBPlot <- ggplot(wrld_simpl2) +
  geom_spatraster_rgb(data = Displace2DRGB,
                      max_col_value =1
                      ) +
  new_scale_fill() + # clear fill set-up 
  # Plot the Ice extend
  geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
  ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement Vs divergence") # Fig title

# Plot Legend 
leg2d <- ggplot() +
  geom_spatraster_rgb(data = XY,
                      max_col_value =1) +
  scale_x_continuous(name = "Displacement [km/100yrs]",
                     breaks = seq(0,10,length.out=7),
                     labels = 10^(-3:3),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Divergence [Degrees]",
                     breaks = seq(0,10,length.out=4),
                     labels = seq(0,180,length.out=4)) +
  theme(axis.text = element_text(size=6),
        axis.title = element_text(size=6,face="bold"),
        panel.background = element_rect(fill='transparent'),
        panel.border = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent'))

# Turn the Legend into a Grob [grid graphical object] to be inserted in a ggplot
g <- ggplotGrob(leg2d)


# Add the legend as a insert to the RGB plot
Map2D <- RGBPlot +
  annotation_custom(
    grob = g,
    xmin = -16800000,
    xmax = -8253891,
    ymin = -8815273,
    ymax = -50573
  )


# Bin size control + color palette
a<- values(Disp.Dive,
              na.rm=T,
              dataframe=T)
a <- a[a[,2]!=0,]
hist2D <- ggplot(round(a,1)) +
  aes(x=x, y=y) +
  geom_hex(bins = 50) +
  scale_fill_continuous(type = "viridis",
                        trans = "log10",
                        na.value = NA,#Do not map NA
                        name = expression(atop('Frequency',
                                          'log'[10]*"(count)")
                          )) +
  scale_x_continuous(name = "Displacement [km/100yrs]",
                     breaks = seq(0,10,length.out=7),
                     labels = 10^(-3:3),
                     guide = guide_axis(n.dodge = 2)) +
  scale_y_continuous(name = "Divergence [Degrees]",
                     breaks = seq(0,10,length.out=4),
                     labels = seq(0,180,length.out=4))
# plot the 2D-map and 2d-Histogram 
ggpubr::ggarrange(Map2D, hist2D,
             nrow = 2,
             labels = c("A", "B"))  
#cor.test(values(log10(Displacement)),
#         values(round(Divergence)),
#         use =  "pairwise.complete.obs")

```


## References
