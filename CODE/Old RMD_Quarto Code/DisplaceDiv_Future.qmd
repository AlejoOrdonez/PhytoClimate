---
title: "Phytoclimate displacement and divergence"
description: 
  Estimation of climate velocity (magnitude and direction) for the Phytoclimate of multiple growth forms
author: Alejandro Ordonez
date: "`r Sys.Date()`"
format:
  html:
    embed-resources: true
    code-fold: true
bibliography: PhytoClim.bib
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| include: false
#| warning: false
library(terra)
library(rasterVis)
library(sp)
require(latticeExtra)
library(maptools)
library(tidyverse)
library(tidyterra)
#library(analogue)
#library(nlme)

# Load the functions to Estimate velocity
source("VelocityFnc.R")

## Countries shapefile
data(wrld_simpl)
wrld_simpl <- spTransform(x = wrld_simpl,
                          CRSobj = CRS("+proj=eck4"))

### Matrix of names
NamesDtFrm <- data.frame(Acronym = c("TE", "TDdry", "TDcold", "TN", "ShE", "ShDdry", "ShDcold","H","Geo", "Thero", "GC3", "GC4", "Suc", "Clim"),
                         Acro2 = c("TE", "TD_dry", "TD_cold", "TN", "ShrE", "ShrD_dry", "ShrD_cold", "H","HGeo", "HThero", "G_C3", "G_C4", "Suc", "C"),
                         Name = c("Evergreen trees", "Drought-deciduous trees", "Cold-deciduous trees", "Needleleaf trees", "Evergreen shrubs", "Drought-deciduous shrubs", "Cold-deciduous shrubs","Herbs", "Geophytes", "Therophytes", "C3 grasses", "C4 grasses", "Succulents", "Climbers"))


```

## Background

Here, I will be calculating one of the the novelty metrics developed in @ordonezMappingClimaticMechanisms2016 (i.e., displacement and divergence) to assess how the rate at which Phytoclimates of multiple growth forms could result in novel assemblages emerging.

**Phytoclimates** for a given growth form (**GF** from here on) can be defined as the number of species form a given GF for which the environmental conditions allow a species to occur. This idea Builds on @conradiOperationalDefinitionBiome2020 on Phyto-climates that builds on his work on operationalizing the definition of the biome for global change research.

Estimates of displacement and divergence builds on calculations magnitude of climate velocity vectors (as defined in @loarieVelocityClimateChange2009) and their bearing (defined in @burrowsPaceShiftingClimate2011).

## Loading the data.

```{r}
#| label: Load Data
#| include: false

### Load the preset data
Present <- rast(dir("./Data/Future climate/present-day/",
                    full.names = TRUE))
names(Present) <- sort(NamesDtFrm$Acro2)

### Load the future values under RCP26 scenario
RCP26 <- rast(dir("./Data/Future climate/RCP26/",
                    full.names = TRUE))
names(RCP26) <- sort(NamesDtFrm$Acro2)

### Load the future values under RCP85 scenario
RCP85 <- rast(dir("./Data/Future climate/RCP85/",
                    full.names = TRUE))
names(RCP85) <- sort(NamesDtFrm$Acro2)
```

I will estimate expected the velocities/bearings for each GF phytoclimate. The changes will be asses between **present-day** conditions (predictions based on the mean climatology between 1979 to 2013) and **late 21^st^-century** (mean of predictions based on 2061 to 2080 climatologies).

Before I do this, I will visualize the phytoclimates for each GF conditions under **present-day** conditions (@fig-PlotPresent):

```{r}
#| label: fig-PlotPresent
#| fig-cap: Present phytocliates under present-day (1979-2013 avg) conditions for all 14 growth forms evaluated.
#| warning: false

##### Plot the Suitability Raster for present conditions


levelplot(raster::stack(Present), # level plot only works with raster files
          at=seq(0,0.75,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Present-day (1979-2013 avg) per growth form.",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(col=rev(hcl.colors(100, palette = "RdYlBu"))) # add a legend
) + 
#### Add the country outlines
  layer(sp.lines(wrld_simpl))

```

and under **late 21^st^-century** conditions according to two different Representative Concentration Pathway ([RCPs](https://sedac.ciesin.columbia.edu/ddc/ar5_scenario_process/RCPs.html)):
  
1. **RCP 2.6** (@fig-PlotRCP26): Carbon dioxide (CO2) emissions start declining by 2020 and go to zero by 2100. It represents the scenario that will keep global temperature rise below 2 Â°C by 2100.

```{r}
#| label: fig-PlotRCP26
#| fig-cap: Phytocliates under present-day (1979-2013 avg) conditions for all 14 growth forms evaluated.
#| warning: false

### Plot the Suitability Raster under RCP 2.6
levelplot(raster::stack(RCP26), # level plot only works with raster files
          at=seq(0,0.75,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Per growth form suitability for late 21^st^ century under RCP 2.6 scenario.",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(col=rev(hcl.colors(100, palette = "RdYlBu"))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```

2. **RCP 8.5** (@fig-PlotRCP85): Emissions continue to rise throughout the 21^st^ century, hence representing the e basis for worst-case climate change scenario.

```{r}
#| label: fig-PlotRCP85
#| fig-cap: Phytocliates under present-day (1979-2013 avg) conditions for all 14 growth forms evaluated.
#| warning: false

### Plot the Suitability Raster under RCP 8.5
levelplot(raster::stack(RCP85), # level plot only works with raster files
          at=seq(0,0.75,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Per growth form suitability for late 21^st^ century under RCP 8.5 scenario.",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(col=rev(hcl.colors(100, palette = "RdYlBu"))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```

For both future conditions, the values presented are the *median* of the predictions per-GF over five different global circulation models (CCRM4, CNRM-CM5, FGOALS-g2, MIROC-ESM, and MPI-ESM-LR).

## Estimating climate velocity

The approach used to estimate the Velocity of phytoclimatic change (that is the magnitude and direction of the change vector). Build on the approach developed by @loarieVelocityClimateChange2009 were velocity for an environmental variable (e.g., temperature) is estimated as:
  
$$V_{l} = \frac{\text{d}c/\text{d}t}{\text{d}c/\text{d}x}$$
    
where $\frac{\text{d}c}{\text{d}t}$ is the the ration between the projected change per unit time; and $\frac{\text{d}c}{\text{d}x}$ is the local spatial gradient in the variable of interest.
  
Here, I apply this approach to each GF suitability maps rather than to a single climate variable (like in @serra-diazBioclimaticVelocityPace2014).

The first step is to define the *temporal gradient* (i.e., $\frac{\text{d}c}{\text{d}t}$) that represents projected change per unit time. Furthermore, as only start and end conditions are available *anomaly (difference) between periods* (Present vs late 21^st^ century) divided by the time between the start (1996) and end (2070) points. This is the approach take in @sandelInfluenceLateQuaternary2011.

```{r}
#| label: TempChange
#| warning: false

### temporal gradient for RCP2.6 scenario
RCP26Chng <- (RCP26 - Present)/74
writeRaster(RCP26Chng,
            "./Data/Future climate/Velocity/TempChng/RCP26_AllGF_TempChng.tif",
            overwrite=TRUE)
### temporal gradient for RCP2.6 scenario
RCP85Chng <- (RCP85 - Present)/74
writeRaster(RCP85Chng,
            "./Data/Future climate/Velocity/TempChng/RCP85_AllGF_TempChng.tif",
            overwrite=TRUE)
```

The expected change by the **late 21^st^-century** under RCP 2.6 (@fig-TempChngRCP26) looks like:

```{r}
#| label: fig-TempChngRCP26
#| fig-cap: Absolute temporal gradient (% change per yr) in suitability under the RCP 2.6 scenario for all 14 growth forms evaluated. Values scaled as $X^(1/5)$ for ease of visualization.
#| warning: false

### Plot the Suitability Raster under RCP 2.6
levelplot(raster::stack(abs(RCP26Chng)^(1/5)), # level plot only works with raster files
          at=seq(0,0.35,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Absolute temporal gradient (% change per yr^1/5) under RCP 2.6 scenario.",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(col=rev(hcl.colors(100, palette = "RdYlBu"))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```

The expected change by the **late 21^st^-century** under RCP 8.5 (@fig-TempChngRCP85) looks like:

```{r}
#| label: fig-TempChngRCP85
#| fig-cap: Absolute temporal gradient (% change per yr) in suitability under the RCP 8.5 scenario for all 14 growth forms evaluated. Values scaled as $X^(1/5)$ for ease of visualization.
#| warning: false

### Plot the Suitability Raster under RCP 8.5
levelplot(raster::stack(abs(RCP85Chng)^(1/5)), # level plot only works with raster files
          at=seq(0,0.35,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Absolute temporal gradient (% change per yr^1/5) under RCP 8.5 scenario.",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(col=rev(hcl.colors(100, palette = "RdYlBu"))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```


The second step is to estimating the spatial heterogeneity (change per unit space; i.e., $\frac{\text{d}c}{\text{d}x}$) as in [@burrowsPaceShiftingClimate2011], [@dobrowskiClimateVelocityContiguous2013] and [@ordonezMappingClimaticMechanisms2016]. The metod estimates spatial heterogeneity as the "the slope of proportions" using the maximum average technique ([@burroughPrinciplesGeographicalInformation2015]).

```{r}
#| label: SpaceHet
### Estimate the spatial gradients magnitude using a using the maximum average technique [Burrough & McDonnell 1998].
SpaceHetRast <- lapply(names(Present),
                       function(i){
                         SpatHetFnc(Present[[i]])
                       })
SpaceHetRast <- do.call("c",SpaceHetRast)
writeRaster(SpaceHetRast,
            "./Data/Future climate/Velocity/SpatHet/AllGF_SpatHet.tif",
            overwrite=TRUE)
```

The spatial gradient magnitude, estimated using a using the maximum average technique  (@fig-SpaceHet) looks like:

```{r}
#| label: fig-SpaceHet
#| fig-cap: Spacial gradient (% change per km) in suitability for all 14 growth forms evaluated. Values scaled as $X^(1/5)$ for ease of visualization.
#| warning: false

### Plot the Suitability Raster under RCP 8.5
levelplot(raster::stack(abs(SpaceHetRast)^(1/5)), # level plot only works with raster files
          at=seq(0,0.4,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Spatial gradient [(% per km)^(1/5)]",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(col=rev(hcl.colors(100, palette = "RdYlBu"))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```


With  the spatial heterogeneity, and the temporal heterogeneity I can estimate the velocity as the ratio between these two. Here there is a need to do two corrections based on some mathematical issues of estimating ratios:

1. if the spatial gradients zero (homo genus area) velocity is set to the maximum.
2. if the temporal heterogeneity is zero (no change in time) velocity is set to the minimum.


```{r}
#| label: Velocity

## Estimate the Velocity vector magnitude (Speed) for changes based on RCP 2.6
RCP26VelocityRast <- lapply(names(Present),
                      function(i){
                        Tmp <- VelocityFnc(RCP26Chng[[i]], SpaceHetRast[[i]])
                        Tmp[which(Tmp[]>100)] <- 100 # ensure that the max is 100km per Yr
                        Tmp[which(Tmp[]<0.01)] <- 0.01 # ensure that the max is 0.01km per Yr
                        return(Tmp)
                      })
RCP26VelocityRast <- do.call("c",RCP26VelocityRast)
writeRaster(RCP26VelocityRast,
            "./Data/Future climate/Velocity/Velocity/RCP26_AllGF_Velocity.tif",
            overwrite=TRUE)
## Estimate the Velocity vector magnitude (Speed) for changes based on RCP 8.5
RCP85VelocityRast <- lapply(names(Present),
                      function(i){
                        Tmp <- VelocityFnc(RCP26Chng[[i]], SpaceHetRast[[i]])
                        Tmp[which(Tmp[]>100)] <- 100 # ensure that the max is 100km per Yr
                        Tmp[which(Tmp[]<0.01)] <- 0.01 # ensure that the max is 0.01km per Yr
                        return(Tmp)
                      })
RCP85VelocityRast <- do.call("c",RCP85VelocityRast)
writeRaster(RCP85VelocityRast,
            "./Data/Future climate/Velocity/Velocity/RCP85_AllGF_Velocity.tif",
            overwrite=TRUE)
```

The expected velocity of Phytoclimates by the **late 21^st^-century** under RCP 2.6 (@fig-VelRCP26) looks like:

```{r}
#| label: fig-VelRCP26
#| fig-cap: Velocity of change for Per Growth Form [km / yr] for all 14 growth forms evaluated under RCP 2.6 climatologiest. Values scaled as $log10(X)$ for ease of visualization.
#| warning: false

### Plot the Suitability Raster under RCP 2.6
levelplot(raster::stack(log10(RCP26VelocityRast)), # level plot only works with raster files
          at=seq(-2,2,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Velocity of climate change [km / yr]",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(labels = list(at = -2:2, # add a legend and its properties
                                        labels = 10^c(-2:2),
                                        col=rev(hcl.colors(100, palette = "RdYlBu")))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```

The expected velocity of Phytoclimates by the **late 21^st^-century** under RCP 8.5     (@fig-VelRCP85) looks like:


```{r}
#| label: fig-VelRCP85
#| fig-cap: Velocity of change for Per Growth Form [km / yr] for all 14 growth forms evaluated under RCP 2.6 climatologiest. Values scaled as $log10(X)$ for ease of visualization.
#| warning: false

### Plot the Suitability Raster under RCP 2.6
levelplot(raster::stack(log10(RCP85VelocityRast)), # level plot only works with raster files
          at=seq(-2,2,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Velocity of climate change [km / yr]",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(labels = list(at = -2:2, # add a legend and its properties
                                        labels = 10^c(-2:2),
                                        col=rev(hcl.colors(100, palette = "RdYlBu")))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```


Last, I estimate the bearing of the vector. The calculation of the velocity vector bearing is determined by the East-West and North-South *components* of the spatial gradient. The sum of these define the magnitude and direction of vector of the spatial change (the one defining towards where the incline would move). The **bearing** of this resulting vector is the angle measured clockwise with 90o centered on the corresponding pole. Therefore, an angle ranging between 0 and 180 means the vector is Polewards bound and angles between 180 and 359 degrees is Equatorward bound. A 0 bearing means the vector is Eastbound in both the Northern and Southern hemisphere, and an angle of 180 is Westbound both the Northern and Southern hemisphere.


```{r}
#| label: BearingRast
### Estimate the Bearing for considering the changes under RCP 2.6
RCP26BearingRast <- lapply(names(Present),
                      function(i){
                        Tmp <- BearingFnc(c(Present[[i]],
                                            RCP26[[i]]))
                        return(Tmp)
                      })
RCP26BearingRast <- do.call("c",RCP26BearingRast)
names(RCP26BearingRast) <- names(Present)
writeRaster(RCP26BearingRast,
            "./Data/Future climate/Velocity/Bearing/RCP26_AllGF_Bearing.tif",
            overwrite=TRUE)

### Estimate the Bearing for considering the changes under RCP 8.5
RCP85BearingRast <- lapply(names(Present),
                      function(i){
                        Tmp <- BearingFnc(c(Present[[i]],
                                            RCP85[[i]]))
                        return(Tmp)
                      })
RCP85BearingRast <- do.call("c",RCP85BearingRast)
names(RCP85BearingRast) <- names(Present)
writeRaster(RCP85BearingRast,
            "./Data/Future climate/Velocity/Bearing/RCP85_AllGF_Bearing.tif",
            overwrite=TRUE)
```

Considering the current spatial pattern and changes under RCP 2.6 the bearing of Phytoclimates velocity vectors (@fig-BearRCP26) looks like:

```{r}
#| label: fig-BearRCP26
#| fig-cap: Bearinf od velocy of change vectors for Per Growth Form [Degres from East] for all 14 growth forms evaluated under RCP 2.6 climatologiest.
#| warning: false

# plot the Spatial gradient considering change under RCP 2.6
levelplot(raster::stack(RCP26BearingRast), # level plot only works with raster files
          scales = list(draw=FALSE), # To remove the Latlong
          main=list("Bearing [Degrees from East]",side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(at=seq(0,360,length.out=100),  # add a legend and its properties
                        labels = list(at = seq(0,360,by=90),
                                      labels = c("Eastward", "Poleward","Westward", "Equatorward",
                                                 "Eastward"),
                                      col=rev(hcl.colors(100, palette = "RdYlBu"))))
          ) +
# Add the country outlines
layer(sp.lines(wrld_simpl)
      )
```

Considering the current spatial pattern and changes under RCP 8.5 the bearing of Phytoclimates velocity vectors (@fig-BearRCP85) looks like:


```{r}
#| label: fig-BearRCP85
#| fig-cap: Bearinf od velocy of change vectors for Per Growth Form [Degres from East] for all 14 growth forms evaluated under RCP 8.5 climatologiest.
#| warning: false

# plot the Spatial gradient considering change under RCP 2.6
levelplot(raster::stack(RCP85BearingRast), # level plot only works with raster files
          scales = list(draw=FALSE), # To remove the Latlong
          main=list("Bearing [Degrees from East]",side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(at=seq(0,360,length.out=100),  # add a legend and its properties
                        labels = list(at = seq(0,360,by=90),
                                      labels = c("Eastward", "Poleward","Westward", "Equatorward",
                                                 "Eastward"),
                                      col=rev(hcl.colors(100, palette = "RdYlBu"))))
          ) +
# Add the country outlines
layer(sp.lines(wrld_simpl)
      )
```


With all this information we can now estimate the displacement of phytoclimatic change and use it as a metric of Ecological Novelty. As defined in [@ordonezMappingClimaticMechanisms2016], displacement of climatic vectors is the geometric mean of multiple velocity vectors. This metric indicates how "fast" would/will an environmental setup (weighting all variables equally) would move given the balance of local environmental gradients and temporal trends in environmental variables. A fast displacement suggests that the magnitudes of velocity vectors (i.e., speed) are rather large, whereas slow displacement indicate that the magnitudes of velocity vectors is small across evaluated growth forms.


```{r}
#| label: Displacement

### Displacement under RCP2.6
RCP26Displace <- 10^(mean(log10(RCP26VelocityRast)))
writeRaster(RCP26Displace,
            "./Data/Future climate/Displacement/RCP26_AllGF_Displacement.tif",
            overwrite=TRUE)
### Displacement under RCP8.5
RCP85Displace <- 10^(mean(log10(RCP85VelocityRast)))
writeRaster(RCP85Displace,
            "./Data/Future climate/Displacement/RCP85_AllGF_Displacement.tif",
            overwrite=TRUE)
```

Visualizing the displacement of Phytoclimates under both RCP 2.6 and 8.5 (@fig-Displacement) looks like:

```{r}
#| label: fig-Displacement
#| fig-cap: Displacement [km / yr] estimated as the geomteric mean over the velocity vector magnitues accross all 14 growth forms evaluated under both RCP 2.6 and 8.5 climatologiest. Values scaled as $log10(X)$ for ease of visualization.
#| warning: false

### Plot the Suitability Raster under RCP 2.6
DisplaceStack <- raster::stack(log10(c(RCP26Displace,RCP85Displace)))
names(DisplaceStack) <- c("RCP26","RCP85")
levelplot(DisplaceStack, # level plot only works with raster files
          at=seq(-2,2,length.out=100), # Set the zlim
          scales = list(draw=FALSE), # To remove the Latlong
          main = list("Displacement of climate change [km / yr]",
                      side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(labels = list(at = -2:2, # add a legend and its properties
                                        labels = 10^c(-2:2),
                                        col=rev(hcl.colors(100, palette = "RdYlBu")))) # add a legend
) + 
### Add the country outlines
  layer(sp.lines(wrld_simpl))
```

Likewise, using the bearing of the velocity vectors I estimate the divergence of phytoclimatic vectors as the standard deviations of bearings as in [@burkeDifferingClimaticMechanisms2019]. This metric indicates how "variable" are the directions of velocity vectors in a given location for the 14 evaluated growth forms. A low divergence suggests that all velocity vectors of all climate variables would tend to shift along the same axis of direction, whereas high divergences indicate that velocity vectors lack congruence in orientation and hence so might species distribution shifts.

```{r}
#| label: Divergence
### Estimate the Divergence considering the changes under RCP 2.6
RCP26Divergence <- app(RCP26BearingRast,sd,na.rm=T)
writeRaster(RCP26Divergence,
            "./Data/Future climate/Divergence/RCP26_AllGF_Divergence.tif",
            overwrite=TRUE)
### Estimate the Divergence considering the changes under RCP 8.5
RCP85Divergence <- app(RCP85BearingRast,sd,na.rm=T)
writeRaster(RCP85Divergence,
            "./Data/Future climate/Divergence/RCP85_AllGF_Divergence.tif",
            overwrite=TRUE)
```

Visualizing the Divergence of Phytoclimates under both RCP 2.6 and 8.5 (@fig-Divergence) looks like:

```{r}
#| label: fig-Divergence
#| fig-cap: Divergence [Degrees] estimated as the stand deviation over the velocity vector bearings accross all 14 growth forms evaluated under both RCP 2.6 and 8.5 climatologiest.
#| warning: false

### Plot the Suitability Raster under RCP 2.6
DivergenceStack <- raster::stack(c(RCP26Divergence,RCP85Divergence))
names(DivergenceStack) <- c("RCP26","RCP85")

# plot the Spatial gradient
levelplot(DivergenceStack, # level plot only works with raster files
          scales = list(draw=FALSE), # To remove the Latlong
          main=list("Divergence [Degrees from East]",side=1,line=-0.5), # Main title
          col.regions = rev(hcl.colors(100,"RdYlBu")), # set the colors
          colorkey = list(at=seq(0,360,length.out=100),  # add a legend and its properties
                        labels = list(at = seq(0,360,by=90),
                                      labels = c("Eastward", "Poleward","Westward", "Equatorward",
                                                 "Eastward"),
                                      col=rev(hcl.colors(100, palette = "RdYlBu"))))
          ) +
# Add the country outlines
layer(sp.lines(wrld_simpl)
      )
```
