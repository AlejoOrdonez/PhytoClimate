---
title: "PhytoClimSlides"
subtitle: Climatic forcing of global ecosystem changes from the Last Glacial Maximum to the end of the 21st century
format:
  revealjs:
    embed-resources: true
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: setup
#| include: false
library(terra)
library(maptools)
library(tidyterra)
library(tidyverse)
library(ggnewscale)
setwd("/Users/alejandroordonez/Dropbox/Other Papers in progress/[Conradi] Phytoclimate  Velocity/PhytoClimate")
## Ice sheets 21ka BP
Ice <- rast("./Data/IceCover21kaBP.tif") 
## Countries shapefile
data(wrld_simpl)
wrld_simpl <- spTransform(x = wrld_simpl,
                          CRSobj = CRS("+proj=eck4"))
wrld_simpl2 <- vect(wrld_simpl)
### Matrix of names
NamesDtFrm <- data.frame(Acronym = c("TE", "TDdry", "TDcold", "TN", "ShE", "ShDdry", "ShDcold","H","Geo", "Thero", "GC3", "GC4", "Suc", "Clim"),
                         Acro2 = c("TE", "TD_dry", "TD_cold", "TN", "ShrE", "ShrD_dry", "ShrD_cold", "H","HGeo", "HThero", "G_C3", "G_C4", "Suc", "C"),
                         Name = c("Evergreen trees", "Drought-deciduous trees", "Cold-deciduous trees", "Needleleaf trees", "Evergreen shrubs", "Drought-deciduous shrubs", "Cold-deciduous shrubs","Herbs", "Geophytes", "Therophytes", "C3 grasses", "C4 grasses", "Succulents", "Climbers"))
```

## Background

-   **Our goals are:**

    -   developing new metrics of ecosystem change based on velocity *vectors of phytoclimatic* change.

    -   provide a novel and nuanced perspective to identify the ecosystems most at risk from climate change.

## **What are Phytoclimates?**

Summary of the climate's suitability for plant species with a given growth forms (e.g. evergreen tree, grass).

-   Measured as % of spp of a GF that can live in a site **OR** as avg suitability of Spp in a GF.
-   Is derived from a physiological informed suitability model.

## How novel are current phytoclimates?

```{r}
#| label: MapNovelty1
#| fig-align: center

# Load Distance Raster
ChiDistRast <- rast("./Data/LGM/Novelty/ChiD_min.tif")
CordDistRast <- rast("./Data/LGM/Novelty/CordD_min.tif")
# Load ROC Threshold 
Map0k.ChiD.ROC <- readRDS("./Data/LGM/Novelty/ChiDROC.rds")
Map0k.CordD.ROC <- readRDS("./Data/LGM/Novelty/CordDROC.rds")
# defining the suitable cut-off value
ChiDCutOffVal <- Map0k.ChiD.ROC$statistics["Combined","Opt. Dis."]
CordDCutOffVal <- Map0k.CordD.ROC$statistics["Combined","Opt. Dis."]
# Create the cut-off map
ChiDCutOffRast <- ChiDistRast > ChiDCutOffVal
CordDCutOffRast <- CordDistRast > CordDCutOffVal

CutOffRast <- c(ChiDCutOffRast,CordDCutOffRast)
names(CutOffRast) <- c("Chi Dist","Cord Dist")

# Map the novelty
ggplot() +
  geom_spatraster(data = CutOffRast) +
  geom_sf(data = wrld_simpl2, fill = NA) +
  facet_wrap(~lyr) +
  scale_fill_whitebox_d(
    palette = "soft",
    labels = c("No","Yes"),
    na.value = NA
    ) +
  labs(title = "1950's Non-analogue areas Vs. LGM",
       fill="Is Novel?",
       caption = "Present day areas considered Non-analogue areas compared to 21kaBP\n[Disimilarity: Chi Dist And Cord Distance ; cut-off: ROC based].\nLargest compositional changes are modelled in Tropical Andes, Pampas, Central Africa, souther Africa east/south-east Asia, east/south Australia.")

```

This signposts areas where the compound suitability for GF has changed the most.

## What does a velocity vector of a phytoclimate represent?

You can think of it as an index the rapidity and direction of a change in the suitability of environmental conditions for a GF.

-   You can think of this as *"How fast to move to keep the same 'suitability'"*
-   A value of 10km/year means that to compensate the change in 1yr, you would need to look at location 10km away.

## Where are the fastest Phytoclimate changes?

```{r}
#| label: Velocity Sumary
#| fig-align: center

# Load the Velocity Rasters
VelocityRast <- do.call("c",
                        lapply(dir("./Data/LGM/Velocity/Velocity_Anomaly1",
                                   pattern ="All_",
                                   full.names = TRUE),
                               function(x){rast(x)}))
names(VelocityRast) <- sort(NamesDtFrm$Acronym)

# Plot the Velocities 
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = log10(VelocityRast)) + # Map the Displacement
# Setup. plot ofr coninous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        labels = 10^(-3:3), # Legend Labels
                        name = "Speed\n[km*100yrs]" # Legend Title
                        ) +
  facet_wrap(~lyr) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate Velocities", # Fig title
        caption = "Rate at which each phytoclimates would have moved between the LGM to the Present day\n[Speed km/100yrs]." # fig Caption
  )

```

## What does the displacement of phytoclimate velocity vector represent?

A compound metric of change, that shows the *average* rapidity in the response across the 14 growth forms we evaluate.

-   You can think of it as a metric of how fast would you need to move the keep the same suitability composition for ALL GF in a location.
    -    \*Could this be considered how fast would a given GF assemblage (defined by their suitability) need to move to in response to environmental changes?\*

## Where are the fastest compound phytoclimate changes?

```{r}
#| label: MapNovelty2
#| fig-align: center

#Load the Displacment values
Displacement <- rast("./Data/LGM/Displacement/Displacement_Anomaly1/All_Displacement.tif")

## ggplot
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = log10(Displacement)) + # Map the Displacement
# Setup. plot ofr coninous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        labels = 10^(-3:3), # Legend Labels
                        name = "Speed\n[km*100yrs]" # Legend Title
                        ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement.", # Fig title
        caption = "Rate at which phytoclimates would have moved between the LGM to the Present day\n[Displacement km/100yrs].")# fig Caption
       
# plot(log10(Displacement),
#      col=rev(hcl.colors(100, palette = "RdYlBu")),
#      plg = list(loc = "bottom", title = "Displacement [km / 100yrs]",
#                 at = -3:3,
#                 labels = 10^(-3:3)),
#      mar=c(6,2,2,2))
# plot(wrld_simpl,add=T)
# image(Ice,add=T,col=rgb(211,211,211,alpha = 211,maxColorValue = 255))
```

## Directionality of the Vectors

Velocity vectors also have a directionality component (here measured as poleward Bearings) based on the idea that "suitability would move from high to low values".

-   Here the Bearings consider the direction in Poleward (90) Vs. Equatorial  (270) degrees.

## Mapping the Bearing of velocity vectors.

```{r}
#| label: Bearing
#| fig-align: center

# Load the Bearing of Velocity Rasters
BearingRast <- do.call("c",
                        lapply(dir("./Data/LGM/Velocity/Bearing/",
                                   pattern ="All_",
                                   full.names = TRUE),
                               function(x){rast(x)}))
names(BearingRast) <- sort(NamesDtFrm$Acronym)

# Plot the Velocities 
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = BearingRast) + # Map the Displacement
# Setup. plot ofr coninous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        breaks = c(0,90,180,270,360),
                        labels = c("E","Pl","W","S","E"), # Legend Labels
                        name = "Bearing" # Legend Title
                        ) +
  facet_wrap(~lyr) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Bearing of Phytoclimate Velocities", # Fig title
        caption = "Direction each phytoclimates would have moved between the LGM to the Present day\n[Degrees]." # fig Captio
  )
```

## What does the divergence of phytoclimate velocity vector represent?

You can think of it as a compound metric of the concordance in the directionality of the velocity vectors across the 14 growth forms we evaluate.

-   It shows if the direction different GF in location would take is the same or not.
-   The concordance in the bearing of velocity vectors shows of the gradients of suitability will result in different GF moving in the same or different directions.

## Where are Phytoclimate vectors moving in different directions?

```{r}
#| labels: Divergence
#| fig-align: center
Divergence <- rast("./Data/LGM/Divergence/All_Divergence.tif")

## ggplot
ggplot(wrld_simpl2) + # add the vector of the world
  geom_spatraster(data = Divergence) + # Map the Displacement
# Setup. plot ofr coninous raster
  scale_fill_whitebox_c(palette = "muted", #colour scheme 
                        na.value = NA,#Do not map NA
                        breaks = c(0,90,170),
                        labels = c("Concord","Diverge","Oposite"),
                        name = "Divergence\n[sd of Bearings]" # Legend Title
                        ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate divergence", # Fig title
        caption = "Congruence in the Bearing of velocity vectors between \n[Sd of Bearings]." # fig Caption
       )

```

## Matching Displacement and Divercence metrics?

```{r}
#| label: DisplDiver2d
#| fig-align: center

# Functions for 2D colors
colors=c("orange","blue","yellow", "red")
colors <- col2rgb(colors)/255
interpolate <- function(i){
  if(!is.na(i[1])){
    x <- i[1]
    y <- i[2]
    x1 <- colors[,2] * x + colors[,3] * (1-x)
    x2 <- colors[,1] * x + colors[,4] * (1-x)
    x2 * y + x1 * (1-y)
  } else{
    c(NA,NA,NA)
  }
}

# Scale Displacement
DisplaceScl <- app(Displacement,function(x){scales::rescale(x,from = as.numeric(minmax(Displacement)))})
# Scale Divergence
DivergenceScl <- app(Divergence,function(x){scales::rescale(x,from = c(0,as.numeric(minmax(Divergence))[2]))})

# Merge into a single SpatRaster
DisDiv2D <- c(DisplaceScl,
              DivergenceScl)
# Turn values into RGB 
DisDiv2DRGB <- app(DisDiv2D,
                   interpolate)

# PLot the RGB
ggplot(wrld_simpl2) +
  geom_spatraster_rgb(data = DisDiv2DRGB,
                      max_col_value =1,
                      ) +
  new_scale_fill() + # clear fill set-up 
# Plot the Ice extend
    geom_spatraster(data = Ice,
                  show.legend = FALSE) +
  scale_fill_gradientn(colours = grey(0.4,alpha=0.5), # Colour as grey
                       na.value = NA # Do not plot NAs
                       ) +
  geom_spatvector(fill = NA) + # Add the vector of the world
  labs(title = "Phytoclimate displacement Vs divergence", # Fig title
        caption = "Match between  displacement Vs divergence metrics." # fig Caption
       )


```
